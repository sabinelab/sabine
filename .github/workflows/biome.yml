name: Biome Format and Check
on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.detect.outputs.workspaces }}
      has_workspaces: ${{ steps.detect.outputs.has_workspaces }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Detect changed workspaces
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          
          WORKSPACES=$(echo "$CHANGED_FILES" | \
            grep -E '^(apps|packages)/' | \
            cut -d'/' -f1,2 | \
            sort -u | \
            while read workspace; do
              if [ -f "$workspace/biome.json" ]; then
                echo "$workspace"
              fi
            done | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "workspaces=$WORKSPACES" >> $GITHUB_OUTPUT
          
          if [ "$WORKSPACES" = "[]" ] || [ -z "$WORKSPACES" ]; then
            echo "has_workspaces=false" >> $GITHUB_OUTPUT
          else
            echo "has_workspaces=true" >> $GITHUB_OUTPUT
          fi

  format-and-review:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_workspaces == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      matrix:
        workspace: ${{ fromJson(needs.detect-changes.outputs.workspaces) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          
      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest
          
      - name: Attempt to apply Biome fixes
        run: |
          cd ${{ matrix.workspace }}
          biome check --write --no-errors-on-unmatched . || echo "Issues found, attempting auto-commit..."
          
      - name: Commit automatic fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'style(${{ matrix.workspace }}): apply automatic Biome fixes'
          file_pattern: '${{ matrix.workspace }}/**'
          
      - name: Run Biome via Reviewdog (PR Only)
        if: github.event_name == 'pull_request'
        uses: mongolyy/reviewdog-action-biome@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          filter_mode: diff_context
          fail_level: error
          workdir: ${{ matrix.workspace }}
          
      - name: Run Biome Check (Push Only)
        if: github.event_name == 'push'
        run: |
          cd ${{ matrix.workspace }}
          biome ci .