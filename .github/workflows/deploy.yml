name: Deploy Apps
on:
  push:
    branches:
      - 'main'
jobs:
  deploy:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            sabine:
              - 'apps/sabine/**'
              - '!**/*.md'
            helper:
              - 'apps/helper/**'
              - '!**/*.md'
            web:
              - 'apps/web/**'
              - '!**/*.md'
            api:
              - 'apps/api/**'
              - '!**/*.md'
            all:
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
              - 'docker-compose.yml'
              - '!**/*.md'
              - '!crowdin.yml'
              - '!.github/dependabot.yml'

      - name: Setup ssh
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/sabine
          chmod 600 ~/.ssh/sabine
          cat >>~/.ssh/config << END
          Host prod
            HostName $SSH_HOST
            User $SSH_USERNAME
            Port $SSH_PORT
            IdentityFile ~/.ssh/sabine
            StrictHostKeyChecking no
          END
        env:
          SSH_USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: 22

      - name: Calculate changes and deploy
        env:
          CHANGED_SABINE: ${{ steps.changes.outputs.sabine }}
          CHANGED_HELPER: ${{ steps.changes.outputs.helper }}
          CHANGED_WEB: ${{ steps.changes.outputs.web }}
          CHANGED_API: ${{ steps.changes.outputs.api }}
          CHANGED_ALL: ${{ steps.changes.outputs.all }}
        run: |
          # Construct list of services to deploy
          SERVICES_TO_DEPLOY=""
          
          if [ "$CHANGED_ALL" == "true" ]; then
            SERVICES_TO_DEPLOY="all"
          else
            [ "$CHANGED_SABINE" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY sabine"
            [ "$CHANGED_HELPER" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY helper"
            [ "$CHANGED_WEB" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY web"
            [ "$CHANGED_API" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY api"
          fi

          # Trim leading space
          SERVICES_TO_DEPLOY=$(echo $SERVICES_TO_DEPLOY | xargs)

          if [ -z "$SERVICES_TO_DEPLOY" ]; then
            echo "No deployable changes detected."
            exit 0
          fi

          echo "Deploying: $SERVICES_TO_DEPLOY"

          # Pass the variable to the SSH command using proper expansion
          ssh prod "cd sabine/sabine && git pull && SERVICES=\"$SERVICES_TO_DEPLOY\" bash -c '
            if [ \"\$SERVICES\" == \"all\" ]; then
              echo \"Full rebuild triggered...\"
              docker compose up -d --build
            else
              for service in \$SERVICES; do
                echo \"Rebuilding \$service...\"
                docker compose up -d --build \$service
                echo \"Waiting 10s for stability...\"
                sleep 10
              done
            fi
          '"