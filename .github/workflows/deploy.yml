name: Deploy Apps
on:
  push:
    branches:
      - 'main'
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - '.github/dependabot.yml'
      - 'crowdin.yml'
jobs:
  deploy:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            sabine:
              - 'apps/sabine/**'
            helper:
              - 'apps/helper/**'
            web:
              - 'apps/web/**'
            api:
              - 'apps/api/**'
            global:
              - '*'
              - 'packages/**'
              - '!**/*.md'
              - '!**/*.mdx'
              - '!crowdin.yml'
              - '!.github/dependabot.yml'

      - name: Setup ssh
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/sabine
          chmod 600 ~/.ssh/sabine
          cat >>~/.ssh/config << END
          Host prod
            HostName $SSH_HOST
            User $SSH_USERNAME
            Port $SSH_PORT
            IdentityFile ~/.ssh/sabine
            StrictHostKeyChecking no
          END
        env:
          SSH_USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: 22

      - name: Calculate changes and deploy
        env:
          CHANGED_SABINE: ${{ steps.changes.outputs.sabine }}
          CHANGED_HELPER: ${{ steps.changes.outputs.helper }}
          CHANGED_WEB: ${{ steps.changes.outputs.web }}
          CHANGED_API: ${{ steps.changes.outputs.api }}
          CHANGED_GLOBAL: ${{ steps.changes.outputs.global }}
          DEPLOY_DELAY_SECONDS: 15
        run: |
          # Construct list of services to deploy
          SERVICES_TO_DEPLOY=""
          
          if [ "$CHANGED_GLOBAL" == "true" ]; then
            SERVICES_TO_DEPLOY="sabine helper web api"
          else
            [ "$CHANGED_SABINE" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY sabine"
            [ "$CHANGED_HELPER" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY helper"
            [ "$CHANGED_WEB" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY web"
            [ "$CHANGED_API" == "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY api"
          fi

          # Trim leading space
          SERVICES_TO_DEPLOY=$(echo $SERVICES_TO_DEPLOY | xargs)

          if [ -z "$SERVICES_TO_DEPLOY" ]; then
            echo "No deployable changes detected."
            exit 0
          fi

          echo "Deploying: $SERVICES_TO_DEPLOY"

          # Pass variables to the SSH command using proper expansion
          ssh prod "cd sabine/sabine && git pull && SERVICES=\"$SERVICES_TO_DEPLOY\" DEPLOY_DELAY=\"$DEPLOY_DELAY_SECONDS\" bash -c '
            for service in \$SERVICES; do
              echo \"Rebuilding \$service...\"
              docker compose up -d --build \$service
              echo \"Waiting \${DEPLOY_DELAY}s for VPS stability...\"
              sleep \$DEPLOY_DELAY
            done
          '"
