name: Deploy Apps
on:
  push:
    branches:
      - 'main'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.detect.outputs.workspaces }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      rebuild_all: ${{ steps.detect.outputs.rebuild_all }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          json: true
          files_ignore: |
            **.md
            .gitignore
            README*
            LICENSE
            crowdin.yml

      - name: Detect changed workspaces
        id: detect
        run: |
          ALL_CHANGED_FILES='${{ steps.changed-files.outputs.all_changed_files }}'
          REBUILD_ALL="false"
          HAS_CHANGES="false"
          WORKSPACES="[]"

          if echo "$ALL_CHANGED_FILES" | jq -r '.[]' | grep -qE '^(package\.json|bun\.lock|docker-compose\.yml|packages/|prisma/)'; then
            REBUILD_ALL="true"
            HAS_CHANGES="true"
            WORKSPACES=$(find apps -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            WORKSPACES=$(echo "$ALL_CHANGED_FILES" | jq -r '.[]' | grep '^apps/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            
            if [ "$WORKSPACES" != "[]" ] && [ -n "$WORKSPACES" ]; then
              HAS_CHANGES="true"
            fi
          fi

          echo "workspaces=$WORKSPACES" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "rebuild_all=$REBUILD_ALL" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.detect.outputs.has_changes == 'true' && (contains(steps.detect.outputs.workspaces, 'apps/sabine') || steps.detect.outputs.rebuild_all == 'true')
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Verify i18n
        if: steps.detect.outputs.has_changes == 'true' && (contains(steps.detect.outputs.workspaces, 'apps/sabine') || steps.detect.outputs.rebuild_all == 'true')
        run: node scripts/verify-i18n.js

  deploy-selective:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && needs.detect-changes.outputs.rebuild_all == 'false'
    name: 'Deploy ${{ matrix.workspace }}'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: ${{ fromJson(needs.detect-changes.outputs.workspaces) }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/sabine
          chmod 600 ~/.ssh/sabine
          cat >>~/.ssh/config << END
          Host prod
            HostName $SSH_HOST
            User $SSH_USERNAME
            Port $SSH_PORT
            IdentityFile ~/.ssh/sabine
            StrictHostKeyChecking no
          END
        env:
          SSH_USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: 22
          
      - name: Deploy ${{ matrix.workspace }}
        run: |
          echo "Deploying ${{ matrix.workspace }}..."
          ssh prod 'cd sabine/sabine && git pull && docker compose up -d --build ${{ matrix.workspace }}'

  deploy-full:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && needs.detect-changes.outputs.rebuild_all == 'true'
    name: 'Deploy All Services (Dependencies Updated)'
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/sabine
          chmod 600 ~/.ssh/sabine
          cat >>~/.ssh/config << END
          Host prod
            HostName $SSH_HOST
            User $SSH_USERNAME
            Port $SSH_PORT
            IdentityFile ~/.ssh/sabine
            StrictHostKeyChecking no
          END
        env:
          SSH_USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: 22
          
      - name: Deploy all workspaces sequentially
        run: |
          echo "Dependencies updated - deploying all services sequentially"
          WORKSPACES='${{ needs.detect-changes.outputs.workspaces }}'
          
          ssh prod "cd sabine/sabine && git pull"
          
          for workspace in $(echo $WORKSPACES | jq -r '.[]'); do
            echo "==> Deploying $workspace..."
            ssh prod "cd sabine/sabine && docker compose up -d --build $workspace"
            echo "âœ“ $workspace deployed"
            echo ""
            sleep 5
          done
          
          echo "All services deployed successfully!"